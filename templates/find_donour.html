<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Blood Donation Finder</title>
<style>
:root{
  --bg: #e0f7ff; /* soft sky blue background */
  --card: #ffffffcc; /* slightly transparent white cards */
  --text: #1b1b1b; /* main text color */
  --muted: #555555; /* muted text */
  --accent: #f62261; /* vibrant red accent */
  --secondary: #208ef4; /* blue accent */
  --success: #16a34a;
  --warn: #ef4444;
  --glow: #ffdde1; /* subtle glow for headings */
  --highlight: #f8b6c3; /* light pink highlight */
}
*{box-sizing:border-box}
body{
  margin:0; font-family:'Poppins', sans-serif; background:var(--bg); color:var(--text); line-height:1.5;
}
header{
  padding:40px 16px; text-align:center; background:linear-gradient(135deg, #ef3636, #ef3636);
  border-bottom-left-radius:25px; border-bottom-right-radius:25px;
  box-shadow:0 6px 20px rgba(0,0,0,0.2);
  position: relative; /* <--- make absolute children positioned relative to header */
}
h1{
  margin:0; font-size:3rem; color:white; text-shadow: 0 0 12px var(--glow);
}
.help{
  font-size:1.3rem; color:white; margin-top:10px;
  text-shadow: 0 0 5px #fff, 0 0 10px #d53d5e;
  background: var(--secondary); /* solid blue background */
  display:inline-block;
  padding:12px 18px;
  border-radius:12px;
}

/* Back to home small button (left corner) */
.back-btn{
  position: absolute;
  left: 16px;
  top: 16px;
  background: rgba(255,255,255,0.95);
  color: var(--accent);
  padding: 8px 12px;
  border-radius: 10px;
  font-weight: 700;
  text-decoration: none;
  box-shadow: 0 6px 18px rgba(0,0,0,0.18);
  border: 1px solid rgba(0,0,0,0.06);
  display: inline-flex;
  align-items: center;
  gap: 8px;
  z-index: 999;
  transition: transform .15s ease, box-shadow .15s ease;
}
.back-btn:hover{
  transform: translateY(-2px);
  box-shadow: 0 10px 26px rgba(0,0,0,0.22);
  background: white;
  color: #b61b44;
}
.back-btn:active{ transform: translateY(0); }

/* small icon style (using unicode arrow) */
.back-btn .icon { font-size: 14px; }

/* responsive adjustments */
@media (max-width:600px){
  .back-btn{ left: 8px; top: 8px; padding: 6px 10px; font-size: 13px; }
  h1{ font-size: 2.1rem; }
  .help{ font-size: 1rem; padding:8px 12px; }
}

.container{
  max-width:1100px; margin:20px auto; padding:16px;
}
.card{
  background:var(--card); border-radius:25px; padding:30px;
  box-shadow:0 8px 25px rgba(0,0,0,0.25); backdrop-filter: blur(8px);
}

.controls{
  display:grid; grid-template-columns:1fr auto; gap:16px; align-items:end;
}
label{
  display:block; font-size:1.3rem; font-weight:600; color:var(--accent);
}
select, input[type="text"], textarea{
  width:100%; padding:14px 18px; background:rgba(248, 182, 195,0.2); color:var(--text);
  border:2px solid rgba(248, 182, 195,0.5); border-radius:16px; font-size:1.1rem; outline:none;
  transition:0.3s all;
}
select:focus, input:focus, textarea:focus{
  border-color: var(--accent); box-shadow:0 0 10px var(--accent);
}

button{
  padding:14px 20px; border:none; border-radius:16px; 
  color:white; font-weight:700; cursor:pointer; font-size:1.1rem;
  transition:0.3s all; box-shadow:0 4px 10px rgba(0,0,0,0.2);
}
button:hover{ transform:scale(1.05); }
button:disabled{opacity:.5; cursor:not-allowed; box-shadow:none;}

/* specific button colors */
#searchBtn{ background: var(--secondary); } /* blue */
#notifyBtn{ background: var(--accent); } /* red */

.grid{
  display:grid; grid-template-columns:repeat(2, 1fr); gap:16px; margin-top:20px;
}
.badge{
  display:inline-flex; align-items:center; gap:10px; font-size:1.1rem; color:white;
  background: var(--secondary); /* solid blue */
  padding:10px 16px; border-radius:50px;
  font-weight:700; text-shadow:0 0 5px #000;
}
.table-wrap{
  overflow:auto; max-height:55vh; border-radius:20px; margin-top:20px; box-shadow:0 4px 15px rgba(0,0,0,0.1);
}
table{
  width:100%; border-collapse:collapse; min-width:800px; font-size:1rem;
}
th, td{
  padding:16px; text-align:left; border-bottom:1px solid rgba(0,0,0,0.1);
}
th{
  position:sticky; top:0; background:var(--accent);
  color:white; text-shadow:0 0 5px #fff;
}
tr:hover{background:rgba(248,182,195,0.2)}
.row-actions{
  display:flex; gap:12px; align-items:center; justify-content:flex-end;
}
.pill{
  padding:6px 14px; border-radius:50px; font-size:1rem; background:rgba(248,182,195,0.2);
  border:1px solid rgba(248,182,195,0.5); color:var(--muted); text-shadow:0 0 2px #fff;
}
.toast{
  position:fixed; right:20px; bottom:20px; background:rgba(248,182,195,0.9);
  border:1px solid rgba(248,182,195,0.5); padding:14px 18px; border-radius:16px; display:none; font-weight:600;
  text-shadow:0 0 5px #fff;
}
.toast.show{display:block; animation:fadeIn 0.5s ease-in;}
.notify-box{
  display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-top:25px;
}
textarea{min-height:110px; resize:vertical; font-size:1.1rem}
.footer{
  margin-top:20px; font-size:1.1rem; color:var(--muted); text-align:center; text-shadow:0 0 2px #fff;
}

@keyframes fadeIn{ from{opacity:0; transform:translateY(20px);} to{opacity:1; transform:translateY(0);} }

</style>
</head>
<body>
<header>
  <!-- Back to Home button (left corner) -->
  <a class="back-btn" href="{{ url_for('index') }}" aria-label="Back to home">
    <span class="icon">‚Üê</span><span>Home</span>
  </a>

  <h1>Blood Donation Finder</h1>
  <div class="help">Filter by blood group, review donors, and notify them without exposing emails.</div>
</header>
<div class="container">
  <div class="card">
    <div class="controls">
      <div>
        <label for="bloodGroup">Choose blood group</label>
        <select id="bloodGroup">
          <option value="">-- Select --</option>
          <option>A+</option><option>A-</option>
          <option>B+</option><option>B-</option>
          <option>O+</option><option>O-</option>
          <option>AB+</option><option>AB-</option>
        </select>
      </div>
      <div>
        <button id="searchBtn">Search</button>
      </div>
    </div>

    <div class="grid">
      <div class="badge"><span id="count">0</span> donors found</div>
      <div class="row-actions">
        <button id="notifyBtn" disabled>Notify them</button>
        <span class="pill">Emails hidden</span>
      </div>
    </div>

    <div class="table-wrap">
      <table id="resultsTable">
        <thead>
          <tr>
            <th><input type="checkbox" id="selectAll"/></th>
            <th>Name</th>
            <th>Age</th>
            <th>Gender</th>
            <th>Phone</th>
            <th>Address</th>
            <th>Weight</th>
            <th>Hemoglobin</th>
            <th>Blood Group</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="notify-box">
      <div>
        <label for="subject">Email subject</label>
        <input type="text" id="subject" placeholder="Blood Donation Request"/>
      </div>
      <div>
        <label for="message">Email message</label>
        <textarea id="message" placeholder="Hello, we urgently require donors for ... at ... Please reply if available."></textarea>
      </div>
    </div>

    <div class="footer">Tip: Select rows to notify specific donors, or use the square at the top to select all.</div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const $ = (q) => document.querySelector(q);
const tbody = $("#resultsTable tbody");
const countEl = $("#count");
const selectAll = $("#selectAll");
const notifyBtn = $("#notifyBtn");
const toast = $("#toast");

let currentData = [];

function showToast(msg, ok=true){
  toast.textContent = msg;
  toast.style.borderColor = ok ? "rgba(16,185,129,.6)" : "rgba(239,68,68,.6)";
  toast.classList.add("show");
  setTimeout(()=> toast.classList.remove("show"), 3500);
}

function renderRows(records){
  tbody.innerHTML = "";
  for(const r of records){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input type="checkbox" data-id="${r.id}" class="rowcheck"/></td>
      <td>${r.name ?? ""}</td>
      <td>${r.age ?? ""}</td>
      <td>${r.gender ?? ""}</td>
      <td><a href="tel:${r.phone ?? ""}" style="color:inherit">${r.phone ?? ""}</a></td>
      <td>${r.address ?? ""}</td>
      <td>${r.weight ?? ""}</td>
      <td>${r.hemoglobin ?? ""}</td>
      <td>${r.blood_group ?? ""}</td>
    `;
    tbody.appendChild(tr);
  }
  selectAll.checked = false;
  notifyBtn.disabled = records.length === 0;
}

async function search(){
  let bg = $("#bloodGroup").value.trim().toUpperCase().replace(/\s/g,"");
  if(!bg){ showToast("Please choose a blood group", false); return; }
  try{
    const res = await fetch(`${window.location.origin}/api/predict?blood_group=${encodeURIComponent(bg)}`);
    const data = await res.json();
    if(!data.ok){ throw new Error(data.error || "Unknown error"); }
    currentData = data.records;
    countEl.textContent = data.count;
    renderRows(currentData);
  }catch(e){
    showToast(e.message || "Failed to fetch", false);
  }
}

async function notify(){
  const checked = Array.from(document.querySelectorAll(".rowcheck:checked"));
  const ids = checked.length ? checked.map(el => parseInt(el.dataset.id)) : currentData.map(r => r.id);

  if(ids.length === 0){ showToast("No donors selected", false); return; }

  const payload = {
    ids,
    subject: $("#subject").value.trim() || "Blood Donation Request",
    message: $("#message").value.trim() || "Hello, this is a request for blood donation. Please reply if available."
  };
  try{
    const res = await fetch(`${window.location.origin}/api/notify`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if(!data.ok){ throw new Error(data.error || "Failed to notify"); }
    showToast(`Request sent to ${data.sent} donor(s).`);
  }catch(e){
    showToast(e.message || "Failed to notify", false);
  }
}

$("#searchBtn").addEventListener("click", search);
selectAll.addEventListener("change", () => {
  document.querySelectorAll(".rowcheck").forEach(cb => cb.checked = selectAll.checked);
});
notifyBtn.addEventListener("click", notify);
</script>
</body>
</html>
